---
title: "TBA"
author: "Ty Garber"
format:
  html:
    code-fold: true
    fig-width: 8
    fig-height: 6
editor: source
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load_libraries, include=FALSE}
# libraries
suppressPackageStartupMessages(library(tidyverse))
```



```{r pssp_functions, include = F}
tf_lm_summary <- function (.data, size_limit = 22)
{
  size_limit <- size_limit * 2.54
  .data %>% filter(
    common_name == "Chinook Salmon",
    catch_result_type_code %in%
      c("R", "K"),
    adipose_clip_status_code %in% c("AD", "UM"),!is.na(total_length)
  ) %>% mutate(legal = if_else(total_length >=
                                 size_limit, "Legal", "Sublegal")) %>% tidyr::unite("legal_mark",
                                                                                    legal, adipose_clip_status_code) %>% count(legal_mark) %>%
    tidyr::pivot_wider(names_from = legal_mark, values_from = n)
}
```

```{r load_data, include=FALSE}
# regulation data
regs <- read_csv(
  here::here('data/regs.csv'),
  col_types = cols(
    areacode = col_character(),
    area = col_character()
    )
  ) %>%
  mutate(
    area = str_pad(area, 2, side='left', '0'),
    across(ends_with('_date'), \(x) as.Date(x, '%m/%d/%Y'))
  ) %>%
  janitor::clean_names()

# 'exploded' regulations. each row is a day
daily_regs <- regs %>%
  filter(
    area %in% c('10','11', '09'),
    fishery_status == 'MSF'
  ) %>%
  rowwise() %>%
  mutate(date = list(seq(reg_start_date, reg_end_date, by='day'))) |>
  unnest(date)

# daily estimates. estimates are made by stratum, which is
# the finest unit possible. this data is broken out by day
# (stratum estimate / days in stratum). not exact, especially
# near the thresholds of the focal time period, but  when 
# looking at entire seasons this should be fine.

ests <- read_csv(here::here('data/chinook_ests.csv')) |>
  janitor::clean_names()

tf <- read_csv(here::here('data/test_fishing.csv')) |>
  filter(target_species == 'Chinook salmon') |>
  mutate(across(survey_datetime, as.Date),
         across(catch_area_code, as.character)) |>
  semi_join(daily_regs, # contextualized to open periods
            by=c('survey_datetime'='date', 
                 'catch_area_code' = 'area')
            )


vtr<- read_csv(here::here('data/vtr.csv'))  |>
  mutate(across(survey_datetime, as.Date),
         across(catch_area_code, as.character)) |>
    semi_join(daily_regs, # contextualized to open periods
            by=c('survey_datetime'='date', 
                 'catch_area_code' = 'area')
            )

```


## Introduction

### Proposal

Due to high catches and coinciding with high observed sublegal-to-legal ratios early in summer (time-step 3) fisheries, WDFW is proposing publishing different dates than what appear in the the List of Agreed to Fisheries (LOAF). These dates will always be within the LOAF agreed-to dates, and will target the time period of historic greatest angler success - the month of August. WDFW, using its expanded test fishing monitoring program, will then monitor the legal and marked proportion (percentage of keepers encountered) of Chinook from the LOAF agreed-to and open the fishery early to Chinook retention when the observed test fishing legal and marked proportion approaches its Fishery Regulation Assessment Model (FRAM) counterpart. 

The goal of this proposal is to reduce sport fishing Chinook releases and their associated mortality, while making Area 10 and Area 11 sport fishing seasons more predictable by reducing variability associated with low legal and marked proportions. 


### Issue

Marine Areas 10 and 11 in the Summer of 2023 short Chinook sport seasons in time step 3 relative previous seasons. These fisheries were not only defined by a lack of time on the water with 28 days out of a total of 50 available in Area 10, and 14 days out a total 92 available in Area 11, but also low harvest and high sublegal encounters relative to FRAM pre-season predictions.

Shorter than planned seasons are not unprecedented for Puget Sound Chinook sport fisheries, as all recent intensive monitored Chinook sport fisheries have associated quotas which are managed to and subsequently closed to retention when those quotas are met. Typically in time step 3 (July - September) Areas 10 and 11 have similar opening dates every year: July 16th and July 1st respectively. These dates appear to be before the bulk of the Chinook run returning Puget Sound rivers (See @fig-run-timing). 

```{r run_timing}
#| label: fig-run-timing
#| fig-cap: 'Area 10 and 11 run timing as measured by CPUE'
ests %>%
  inner_join(daily_regs, by=c('area', 'days' = 'date')) %>% # contextualizes to open
  filter(
    lubridate::month(days) %in% c(7,8,9),
    area %in% c('10', '11')
    ) %>%
  transmute(
    area,
    days,
    cpue = chin_ad_ret / anglers,
    disply_year = lubridate::`year<-`(days, 2023)
  ) %>%
  group_by(area, disply_year) %>%
  summarize(mean = mean(cpue, na.rm = T)) %>%
  ggplot(aes(disply_year, mean, group=1)) +
  geom_line() +
  geom_smooth(method = 'gam', se=FALSE) +
  labs(subtitle = 'Mean CPUE Areas 10 and 11 (2007-2023)',
       y = 'Mean CPUE',
       x = 'Date') +
  facet_wrap(~area, ncol = 1, scales = 'free')
```


```{r sublegal_ratios}
# tf_lm <- tf |>
#   filter(lubridate::month(survey_datetime) %in% c(7:9)) |>
#   group_by(catch_area_code, year = lubridate::year(survey_datetime)) |>
#   nest() |>
#   mutate(
#     lm = map(data, tf_lm_summary)
#   ) |>
#   unnest(lm)
# 
# vtr_lm <- vtr |>
#   filter(
#     lubridate::month(survey_datetime) %in% c(7:9)
#          ) |>
#   group_by(
#     catch_area_code, 
#            year = lubridate::year(survey_datetime),
#            legal_size_status_description,
#            adipose_clip_status_code
#   ) |>
#   summarize(
#     acros
#   )
  
```

